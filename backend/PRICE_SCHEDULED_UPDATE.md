# 价格定时更新功能说明

## 功能概述

系统已实现**定时自动更新价格**功能，会定期从网络爬取并更新景点门票价格，无需手动操作。

## 定时任务说明

系统配置了**3个定时任务**，分别用于不同的更新场景：

### 1. 每日价格更新（主要任务）

**执行时间**：每天凌晨 **2:00**

**更新策略**：
- 默认只更新**没有价格**的景点（价格为0或null）
- 已有价格的景点会被跳过（除非配置了强制更新）

**Cron表达式**：`0 0 2 * * ?`

**适用场景**：
- 新添加的景点自动获取价格
- 定期检查并补充缺失的价格数据

### 2. 每周强制更新（全面更新）

**执行时间**：每周一凌晨 **3:00**

**更新策略**：
- **强制更新所有景点**，包括已有价格的景点
- 用于确保价格数据的准确性和时效性

**Cron表达式**：`0 0 3 ? * MON`

**适用场景**：
- 定期全面更新所有景点价格
- 确保价格信息与市场同步

### 3. 每小时快速更新（快速填充）

**执行时间**：每小时整点（如 1:00, 2:00, 3:00...）

**更新策略**：
- 只更新**没有价格**的景点
- 快速填充新添加景点的价格数据

**Cron表达式**：`0 0 * * * ?`

**适用场景**：
- 新景点添加后快速获取价格
- 减少价格缺失的时间窗口

## 配置说明

在 `application.yml` 中可以配置定时任务：

```yaml
price:
  update:
    enabled: true   # 是否启用定时更新（设为false可禁用所有定时任务）
    force: false    # 是否强制更新已有价格的景点（仅影响每日更新）
    cron: "0 0 2 * * ?"  # 每日更新的Cron表达式
    weekly:
      cron: "0 0 3 ? * MON"  # 每周更新的Cron表达式
    hourly:
      cron: "0 0 * * * ?"  # 每小时更新的Cron表达式
```

### 配置项说明

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `enabled` | 是否启用定时更新 | `true` |
| `force` | 是否强制更新已有价格 | `false` |
| `cron` | 每日更新的Cron表达式 | `0 0 2 * * ?` |
| `weekly.cron` | 每周更新的Cron表达式 | `0 0 3 ? * MON` |
| `hourly.cron` | 每小时更新的Cron表达式 | `0 0 * * * ?` |

### Cron表达式格式

```
秒 分 时 日 月 周
```

**常用示例**：

| 表达式 | 说明 |
|--------|------|
| `0 0 2 * * ?` | 每天凌晨2点 |
| `0 0 3 ? * MON` | 每周一凌晨3点 |
| `0 0 * * * ?` | 每小时整点 |
| `0 0 0/6 * * ?` | 每6小时执行一次 |
| `0 0 2 * * 1-5` | 周一到周五凌晨2点 |

## 禁用定时更新

如果需要临时禁用定时更新，可以修改配置：

```yaml
price:
  update:
    enabled: false  # 禁用所有定时任务
```

或者注释掉 `@Scheduled` 注解：

```java
// @Scheduled(cron = "${price.update.cron:0 0 2 * * ?}")
public void scheduledPriceUpdate() {
    // ...
}
```

## 日志查看

定时任务的执行情况会记录在日志中：

```
2025-01-15 02:00:00 INFO  PriceScheduledService - 开始执行定时价格更新任务...
2025-01-15 02:05:30 INFO  PriceScheduledService - 价格更新任务完成 - 成功: 15, 失败: 2, 跳过: 3, 总计: 20
```

## 更新策略优先级

定时任务会按以下顺序尝试获取价格：

1. **AI提取策略**（优先）
2. **网页爬虫策略**
3. **第三方API策略**

如果某个策略失败，会自动尝试下一个策略。

## 性能考虑

### 更新频率建议

- **每日更新**：适合大多数场景，平衡了更新频率和服务器负载
- **每周强制更新**：确保价格准确性，但会增加服务器负载
- **每小时更新**：快速填充新数据，但只更新缺失价格的景点

### 优化建议

1. **错峰执行**：将更新任务安排在凌晨，避免影响用户访问
2. **批量处理**：系统会批量更新所有景点，提高效率
3. **失败重试**：单个景点更新失败不会影响其他景点
4. **日志记录**：详细记录更新结果，便于排查问题

## 手动触发更新

除了定时任务，还可以通过API手动触发更新：

### 更新单个景点
```bash
POST /api/prices/update/{spotId}?force=false
```

### 批量更新所有景点
```bash
POST /api/prices/batch-update?force=false
```

## 监控和告警

建议配置以下监控：

1. **任务执行监控**：检查定时任务是否正常执行
2. **成功率监控**：监控价格更新的成功率
3. **异常告警**：更新失败率过高时发送告警

## 常见问题

### Q1: 定时任务没有执行？

**检查项**：
1. 确认 `enabled: true`
2. 检查应用是否正常运行
3. 查看日志是否有错误信息
4. 确认Cron表达式是否正确

### Q2: 更新失败率很高？

**可能原因**：
1. 网络连接问题
2. 目标网站结构变化
3. API配置错误

**解决方案**：
1. 检查网络连接
2. 更新正则表达式或爬虫策略
3. 检查AI API配置

### Q3: 如何调整更新频率？

修改 `application.yml` 中的Cron表达式：

```yaml
price:
  update:
    cron: "0 0 */6 * * ?"  # 每6小时执行一次
```

### Q4: 如何只更新特定景点？

目前定时任务会更新所有景点。如果需要只更新特定景点，可以：
1. 手动调用API更新单个景点
2. 修改 `PriceScheduledService` 添加过滤逻辑

## 总结

✅ **已实现的功能**：
- 每天凌晨2点自动更新价格
- 每周一凌晨3点强制更新所有价格
- 每小时快速填充缺失价格
- 可配置的更新策略
- 详细的日志记录

✅ **优势**：
- 自动化，无需人工干预
- 多策略备选，提高成功率
- 灵活的配置选项
- 详细的执行日志

系统启动后，定时任务会自动运行，定期更新景点价格，确保价格数据的准确性和时效性。
















