# API 请求 404 问题完整修复指南

## 问题现象

浏览器 Network 标签显示：
- `spots?locale=zh` 返回 404
- `540000_full.json` 返回 403（这是外部资源，不是主要问题）

## 问题分析

### 可能原因 1：前端构建时环境变量未正确注入

如果浏览器请求的是 `spots?locale=zh` 而不是 `/api/spots?locale=zh`，说明 `VITE_API_BASE_URL` 可能没有正确设置。

### 可能原因 2：Nginx 配置未正确加载

即使前端代码正确，如果 Nginx 配置有问题，也会导致 404。

## 完整修复步骤

### 步骤 1：在本地提交所有更改

```bash
# 在本地项目目录
git add frontend/nginx.conf
git commit -m "修复 Nginx 配置：添加 /images 代理，优化 /api 匹配规则"
git push
```

### 步骤 2：在服务器上更新代码

```bash
cd /opt/colorful-tibet
git pull
```

### 步骤 3：检查环境变量配置

```bash
# 检查 .env 文件是否存在
cat .env

# 如果没有 .env 文件，创建一个
cat > .env << 'EOF'
# API 配置
VITE_API_BASE_URL=/api

# 后端配置
SPRING_PROFILES_ACTIVE=local
DOUBAO_API_KEY=e23d1e75-53b0-473d-92dc-8d70395b077b
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3/chat/completions
DOUBAO_MODEL=ep-20251124231555-hdr7j
JWT_SECRET=tibetTourismSecretKey12345678901234567890
ADMIN_ENCRYPTION_KEY=tibetTourismSecretKey12345678901234567890
EOF
```

### 步骤 4：重新构建并启动服务

```bash
# 停止服务
docker-compose down

# 清理旧的前端镜像（可选，但推荐）
docker rmi colorful-tibet-frontend 2>/dev/null || true

# 重新构建前端（确保使用最新的配置和环境变量）
docker-compose build --no-cache frontend

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f frontend
```

### 步骤 5：验证配置

```bash
# 1. 检查前端容器内的 Nginx 配置
docker exec colorful-tibet-frontend cat /etc/nginx/conf.d/default.conf

# 2. 测试 Nginx 配置语法
docker exec colorful-tibet-frontend nginx -t

# 3. 测试后端直接访问
docker exec colorful-tibet-frontend wget -O- http://backend:8080/api/spots | head -20

# 4. 测试 Nginx 代理
docker exec colorful-tibet-frontend wget -O- http://localhost/api/spots | head -20

# 5. 检查构建后的前端代码中的 baseURL
docker exec colorful-tibet-frontend grep -r "baseURL\|VITE_API_BASE_URL" /usr/share/nginx/html/*.js 2>/dev/null | head -5
```

### 步骤 6：浏览器验证

1. **清除浏览器缓存**：
   - 按 `Ctrl+Shift+Delete`（Windows）或 `Cmd+Shift+Delete`（Mac）
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **打开开发者工具**：
   - 按 `F12` 打开开发者工具
   - 切换到 `Network` 标签
   - 勾选 `Disable cache`（禁用缓存）

3. **访问网站**：
   - 打开 `http://1.15.29.168`
   - 查看 Network 标签中的请求

4. **检查 API 请求**：
   - 找到 `spots?locale=zh` 请求
   - 点击查看详情
   - **检查 Request URL**：应该是 `http://1.15.29.168/api/spots?locale=zh`
   - **检查 Status Code**：应该是 `200` 而不是 `404`

## 如果问题仍然存在

### 诊断步骤

1. **检查浏览器控制台**：
   ```javascript
   // 在浏览器控制台运行
   console.log('API Base URL:', window.location.origin + '/api')
   ```

2. **检查构建后的代码**：
   ```bash
   # 在服务器上
   docker exec colorful-tibet-frontend sh -c "grep -o 'baseURL[^,]*' /usr/share/nginx/html/assets/*.js | head -3"
   ```

3. **检查 Nginx 错误日志**：
   ```bash
   docker logs colorful-tibet-frontend 2>&1 | grep -i error | tail -20
   ```

4. **手动测试 API**：
   ```bash
   # 在服务器上
   curl -v http://localhost/api/spots
   ```

### 临时解决方案：添加 Nginx 重写规则

如果前端代码确实请求的是 `spots` 而不是 `/api/spots`，可以在 Nginx 中添加重写规则：

```nginx
# 在 location /api 之前添加
location ~ ^/(spots|auth|news|heritage|routes|bookings|comments|admin) {
    rewrite ^/(.*)$ /api/$1 break;
    proxy_pass http://backend:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**但这不是推荐方案**，应该修复前端代码的 baseURL 配置。

## 验证清单

修复完成后，请确认：

- [ ] `docker exec colorful-tibet-frontend wget -O- http://localhost/api/spots` 返回 JSON 数据
- [ ] 浏览器 Network 标签中 `spots?locale=zh` 请求的完整 URL 是 `http://1.15.29.168/api/spots?locale=zh`
- [ ] 浏览器 Network 标签中请求状态码是 `200`
- [ ] 前端页面可以正常显示数据

## 常见问题

### Q: 为什么浏览器显示的是 `spots?locale=zh` 而不是 `/api/spots?locale=zh`？

A: 这可能是因为：
1. 构建时 `VITE_API_BASE_URL` 没有正确设置
2. 浏览器 Network 标签只显示相对路径，实际请求包含完整路径

**解决方法**：点击 Network 标签中的请求，查看 "Request URL" 字段，确认完整路径。

### Q: 为什么 `540000_full.json` 返回 403？

A: 这是从阿里云获取的地图数据，403 可能是：
1. 网络问题
2. CORS 问题
3. 阿里云服务限制

这不是主要问题，不影响核心功能。

### Q: 如何确认环境变量是否正确传递？

A: 运行以下命令检查：
```bash
docker-compose config | grep VITE_API_BASE_URL
```

应该显示 `VITE_API_BASE_URL=/api`。

