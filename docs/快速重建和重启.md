# 快速重建和重启服务

## 一键执行（推荐）

```bash
cd /opt/colorful-tibet
bash rebuild-and-restart.sh
```

或者直接执行以下命令：

```bash
cd /opt/colorful-tibet && \
docker compose down && \
docker compose build --no-cache && \
docker compose up -d && \
sleep 10 && \
docker compose ps && \
echo "=== 测试后端 ===" && \
curl -s http://localhost:8080/api/spots | head -5 && \
echo "" && \
echo "=== 测试前端代理 ===" && \
curl -s http://localhost/api/spots | head -5
```

## 分步执行

### 步骤 1：停止服务

```bash
cd /opt/colorful-tibet
docker compose down
```

### 步骤 2：清理旧容器和镜像（可选，但推荐）

```bash
# 删除旧容器
docker rm colorful-tibet-frontend colorful-tibet-backend 2>/dev/null || true

# 删除旧镜像（强制重新构建）
docker rmi colorful-tibet-frontend colorful-tibet-backend 2>/dev/null || true
```

### 步骤 3：重新构建

```bash
# 重新构建所有服务（不使用缓存）
docker compose build --no-cache

# 或者只构建特定服务
docker compose build --no-cache frontend
docker compose build --no-cache backend
```

### 步骤 4：启动服务

```bash
docker compose up -d
```

### 步骤 5：等待服务启动

```bash
# 等待 10-30 秒让服务完全启动
sleep 10

# 或者实时查看日志
docker compose logs -f
```

### 步骤 6：验证服务状态

```bash
# 查看服务状态
docker compose ps

# 应该看到两个服务都是 "Up" 状态
# backend 应该显示 "(healthy)"
```

### 步骤 7：测试服务

```bash
# 测试后端 API
curl http://localhost:8080/api/spots

# 测试前端代理
curl http://localhost/api/spots

# 测试前端页面
curl http://localhost
```

## 常见问题

### 问题 1：构建失败

**解决方案**：
```bash
# 查看详细构建日志
docker compose build --no-cache --progress=plain

# 检查 Dockerfile 语法
docker build -t test -f frontend/Dockerfile frontend/
```

### 问题 2：服务启动失败

**解决方案**：
```bash
# 查看错误日志
docker compose logs backend
docker compose logs frontend

# 检查容器状态
docker compose ps -a

# 检查端口占用
sudo netstat -tulpn | grep -E ':(80|8080)'
```

### 问题 3：服务不健康

**解决方案**：
```bash
# 查看健康检查日志
docker inspect colorful-tibet-backend | grep -A 10 Health

# 手动测试健康检查
docker exec colorful-tibet-backend curl -f http://localhost:8080/api/spots
```

## 快速命令参考

```bash
# 停止服务
docker compose down

# 启动服务
docker compose up -d

# 重新构建并启动
docker compose up -d --build

# 查看日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f backend
docker compose logs -f frontend

# 重启服务
docker compose restart

# 重启特定服务
docker compose restart backend
docker compose restart frontend

# 查看服务状态
docker compose ps

# 进入容器
docker exec -it colorful-tibet-backend sh
docker exec -it colorful-tibet-frontend sh
```

## 完整重建流程（包含清理）

```bash
cd /opt/colorful-tibet

# 1. 停止并删除容器
docker compose down

# 2. 删除旧镜像
docker rmi colorful-tibet-frontend colorful-tibet-backend 2>/dev/null || true

# 3. 清理构建缓存（可选）
docker builder prune -f

# 4. 重新构建
docker compose build --no-cache

# 5. 启动服务
docker compose up -d

# 6. 等待启动
sleep 15

# 7. 验证
docker compose ps
curl http://localhost:8080/api/spots | head -10
```

