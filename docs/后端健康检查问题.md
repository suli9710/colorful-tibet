# 后端健康检查问题排查

## ⚠️ 问题：后端容器状态为 unhealthy

### 问题描述

执行 `docker compose ps` 时，后端容器显示：
```
STATUS: Up 4 minutes (unhealthy)
```

### 原因

- 健康检查失败
- 后端服务可能还在启动中
- 健康检查配置可能有问题

### 解决方案

#### 步骤 1：查看后端日志

```bash
# 查看后端详细日志
docker compose logs backend

# 或者实时查看
docker compose logs -f backend
```

#### 步骤 2：检查后端是否正常响应

```bash
# 测试后端 API
curl http://localhost:8080/api/spots

# 或者从外部测试
curl http://1.15.29.168:8080/api/spots
```

#### 步骤 3：检查健康检查配置

查看 `docker-compose.yml` 中的健康检查配置：

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/api/spots"]
  interval: 30s
  timeout: 10s
  retries: 3
```

可能的问题：
- 容器内没有 `curl` 命令
- 后端服务启动较慢，健康检查过早执行

#### 步骤 4：修复健康检查（如果需要）

如果容器内没有 `curl`，可以修改健康检查：

```bash
cd /opt/colorful-tibet
nano docker-compose.yml
```

修改健康检查为使用 `wget` 或 `java` 命令：

```yaml
healthcheck:
  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/spots"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s  # 给服务 60 秒启动时间
```

或者如果后端镜像基于 Alpine，需要安装 curl：

修改 `backend/Dockerfile`：
```dockerfile
FROM eclipse-temurin:17-jre-alpine
RUN apk add --no-cache curl
```

#### 步骤 5：等待服务完全启动

后端服务可能需要一些时间完全启动，等待 1-2 分钟后再次检查：

```bash
# 等待后再次检查
docker compose ps

# 查看日志确认服务已启动
docker compose logs backend | tail -20
```

## 🔍 完整排查流程

```bash
# 1. 查看后端日志
docker compose logs backend

# 2. 测试后端 API
curl http://localhost:8080/api/spots

# 3. 检查容器内是否有 curl
docker exec colorful-tibet-backend which curl

# 4. 如果没有 curl，检查健康检查是否失败
docker inspect colorful-tibet-backend | grep -A 10 Health

# 5. 如果后端 API 正常响应，可以暂时忽略 unhealthy 状态
# 或者修复健康检查配置
```

## 🚀 快速验证

```bash
# 1. 测试后端 API
curl http://localhost:8080/api/spots

# 2. 如果返回 JSON 数据，说明后端正常
# unhealthy 状态可能是健康检查配置问题，不影响实际功能

# 3. 测试前端
curl http://localhost

# 4. 在浏览器访问
# http://1.15.29.168
```

## ⚠️ 注意事项

1. **unhealthy 不等于服务不可用**：如果 API 能正常响应，说明服务实际运行正常
2. **健康检查只是监控工具**：不影响服务的实际功能
3. **可以暂时忽略**：如果服务正常工作，可以稍后修复健康检查配置

## 📝 推荐操作

如果后端 API 能正常响应，可以：

1. **暂时忽略 unhealthy 状态**，继续使用服务
2. **稍后修复健康检查配置**，使用更合适的检查方式
3. **或者移除健康检查**（不推荐，但可以临时解决）

## 🎯 验证服务是否正常

```bash
# 测试后端
curl http://localhost:8080/api/spots

# 测试前端
curl -I http://localhost

# 在浏览器访问
# http://1.15.29.168
# http://1.15.29.168:8080/api/spots
```

如果这些都能正常响应，说明服务已经成功部署！

