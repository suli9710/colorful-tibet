# 后端启动问题排查

## 问题现象

后端服务一直显示 `(health: starting)` 状态，无法变为 `healthy`。

## 诊断步骤

### 1. 检查后端容器状态

```bash
docker compose ps backend
```

### 2. 查看后端日志

```bash
# 查看完整启动日志
docker compose logs backend

# 查看最后 50 行
docker compose logs --tail=50 backend

# 实时查看日志
docker compose logs -f backend
```

### 3. 检查健康检查配置

```bash
# 查看健康检查配置
cat docker-compose.yml | grep -A 5 healthcheck
```

### 4. 手动测试健康检查

```bash
# 进入后端容器
docker exec -it colorful-tibet-backend sh

# 手动执行健康检查命令
curl -f http://localhost:8080/api/spots
```

## 常见原因和解决方案

### 原因 1：后端启动时间过长

Spring Boot 应用首次启动可能需要较长时间（1-2 分钟）。

**解决方案**：
- 增加健康检查的超时时间和重试次数
- 等待更长时间

### 原因 2：健康检查命令失败

健康检查使用的 `curl` 命令可能失败。

**解决方案**：
```bash
# 检查 curl 是否可用
docker exec colorful-tibet-backend which curl

# 如果不可用，修改健康检查命令
# 在 docker-compose.yml 中改为使用 wget 或其他工具
```

### 原因 3：后端启动失败

后端应用可能启动失败，但容器仍在运行。

**解决方案**：
```bash
# 查看详细错误日志
docker compose logs backend | grep -i error

# 检查应用是否真的在运行
docker exec colorful-tibet-backend ps aux | grep java
```

### 原因 4：数据库初始化问题

H2 数据库初始化可能失败。

**解决方案**：
```bash
# 检查数据库文件
ls -la data/

# 删除数据库文件重新初始化
rm -f data/tibet_tourism.mv.db data/tibet_tourism.trace.db
docker compose restart backend
```

## 快速修复

### 方案 1：增加健康检查超时时间

修改 `docker-compose.yml`：

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/api/spots"]
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 120s  # 添加启动宽限期
```

### 方案 2：临时禁用健康检查

如果健康检查有问题，可以临时禁用：

```yaml
# 注释掉 healthcheck 部分
# healthcheck:
#   test: ["CMD", "curl", "-f", "http://localhost:8080/api/spots"]
#   interval: 30s
#   timeout: 10s
#   retries: 3
```

### 方案 3：手动检查后端是否可用

```bash
# 直接测试后端 API
curl http://localhost:8080/api/spots

# 如果返回数据，说明后端已启动，只是健康检查有问题
```

## 验证后端是否真的启动

```bash
# 1. 检查容器进程
docker exec colorful-tibet-backend ps aux

# 2. 检查端口监听
docker exec colorful-tibet-backend netstat -tlnp | grep 8080

# 3. 直接测试 API
curl http://localhost:8080/api/spots

# 4. 查看应用日志
docker compose logs backend | tail -30
```

## 如果后端确实已启动

如果后端 API 可以访问，但健康检查仍然失败，可以：

1. **忽略健康检查**：直接使用后端服务
2. **修复健康检查**：调整健康检查命令或配置
3. **使用 `depends_on` 的 `condition: service_started`**：而不是 `service_healthy`

