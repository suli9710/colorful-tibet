# 快速部署指南

本文档提供最快速的部署方法，适合熟悉 Linux 的用户。

## 🚀 一键部署（推荐）

### ⚠️ 权限说明

**如果使用普通用户（如 `ubuntu`），部署脚本会自动处理权限问题。如果手动执行命令，请在需要管理员权限的命令前加 `sudo`。**

### 前提条件

1. 已购买腾讯云服务器（Ubuntu 22.04 或 CentOS 7.9）
2. 已通过 SSH 连接到服务器
3. 已获取项目代码（Git 仓库或已上传代码）

### 步骤 1：上传项目代码

**方法 A：使用 Git（推荐）**

```bash
cd /opt
# 公开仓库可以直接克隆，无需认证
sudo git clone https://github.com/suli9710/colorful-tibet.git
sudo chown -R $USER:$USER colorful-tibet  # 修改所有者，方便后续操作
cd colorful-tibet
```

**方法 B：使用 SCP 上传**

在本地电脑执行：

```bash
# Windows PowerShell
scp -r C:\Users\Suli\Desktop\colorful-tibet root@您的服务器IP:/opt/
```

### 步骤 2：运行部署脚本

```bash
cd /opt/colorful-tibet
chmod +x deploy-tencent-cloud.sh
./deploy-tencent-cloud.sh
```

脚本会自动：
- ✅ 安装 Docker 和 Docker Compose
- ✅ 配置防火墙规则
- ✅ 创建必要的目录
- ✅ 生成环境变量配置文件
- ✅ 更新 docker-compose.yml
- ✅ 构建并启动服务

### 步骤 3：配置环境变量

编辑 `.env` 文件，填入正确的配置：

```bash
nano /opt/colorful-tibet/.env
```

**必须修改的配置：**
- `DOUBAO_API_KEY` - 您的豆包 API Key
- `DOUBAO_API_URL` - 豆包 API 地址
- `DOUBAO_MODEL` - 豆包模型名称

**可选修改的配置：**
- `JWT_SECRET` - JWT 密钥（脚本已自动生成）
- `ADMIN_ENCRYPTION_KEY` - 管理员加密密钥（脚本已自动生成）

### 步骤 4：重启服务（如果修改了配置）

```bash
cd /opt/colorful-tibet
docker-compose restart
```

### 步骤 5：访问网站

- **前端**: http://您的服务器IP
- **后端 API**: http://您的服务器IP:8080/api/spots

---

## 📝 手动部署步骤

如果自动脚本无法使用，可以按照以下步骤手动部署：

### 1. 安装 Docker

```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo systemctl start docker
sudo systemctl enable docker

# 将用户添加到 docker 组（可选，这样就不需要 sudo）
sudo usermod -aG docker $USER
newgrp docker  # 或重新登录
```

### 2. 安装 Docker Compose

```bash
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 3. 配置环境变量

```bash
cd /opt/colorful-tibet
cp .env.example .env
nano .env  # 编辑配置文件
```

### 4. 修改 docker-compose.yml

编辑 `docker-compose.yml`，将第 36 行的 `VITE_API_BASE_URL` 改为您的服务器 IP：

```yaml
environment:
  - VITE_API_BASE_URL=http://您的服务器IP:8080/api
```

### 5. 启动服务

```bash
docker-compose build
docker-compose up -d
```

### 6. 查看日志

```bash
docker-compose logs -f
```

---

## 🔧 常用命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
docker-compose logs backend
docker-compose logs frontend

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 更新代码后重新部署
git pull
docker-compose build
docker-compose up -d
```

---

## ⚠️ 注意事项

1. **安全组配置**：确保腾讯云安全组已开放以下端口：
   - 22 (SSH)
   - 80 (HTTP)
   - 443 (HTTPS)
   - 8080 (后端 API，可选)

2. **环境变量**：生产环境务必修改 `.env` 文件中的密钥，不要使用默认值。

3. **域名配置**：如需使用域名，请：
   - 配置域名解析（A 记录指向服务器 IP）
   - 安装 SSL 证书（使用 Let's Encrypt）
   - 更新 `VITE_API_BASE_URL` 为域名地址

4. **数据库**：默认使用 H2 内存数据库，生产环境建议使用 MySQL。

---

## 🐛 问题排查

### 服务无法启动

```bash
# 查看详细日志
docker-compose logs

# 检查端口占用
netstat -tlnp | grep 8080

# 检查 Docker 状态
sudo systemctl status docker
```

### 前端无法访问后端

1. 检查后端是否运行：`curl http://localhost:8080/api/spots`
2. 检查 `VITE_API_BASE_URL` 配置是否正确
3. 检查防火墙规则

### 内存不足

```bash
# 查看内存使用
free -h

# 查看 Docker 资源使用
docker stats
```

---

## 📚 更多信息

**详细部署教程请参考**：[腾讯云部署详细教程.md](./腾讯云部署详细教程.md) ⭐ **强烈推荐**

该详细教程包含：
- 完整的服务器购买和配置步骤
- 详细的环境准备说明
- 逐步的代码部署指南
- Docker环境安装和配置
- 环境变量详细配置说明
- 域名和SSL证书配置
- 常见问题排查指南
- 日常维护和更新说明

