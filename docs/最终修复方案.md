# Nginx 404 问题最终修复方案

## 问题确认

从诊断结果看到：
1. **容器内的配置缺少 `^~` 修饰符**：显示 `location /api {` 而不是 `location ^~ /api {`
2. **后端服务正在启动**：状态是 `(health: starting)`，连接被拒绝

## 修复步骤

### 步骤 1：等待后端服务完全启动

```bash
# 等待后端服务启动完成（通常需要 30-60 秒）
docker compose logs -f backend

# 或者等待健康检查通过
watch -n 2 'docker compose ps backend'
# 看到 (healthy) 后按 Ctrl+C 退出
```

### 步骤 2：更新配置文件并重新加载

```bash
cd /opt/colorful-tibet

# 1. 确保主机上的配置文件正确（包含 ^~ 修饰符）
cat frontend/nginx.conf | grep -A 5 "location.*api"

# 应该看到：location ^~ /api {

# 2. 复制配置到容器
docker cp frontend/nginx.conf colorful-tibet-frontend:/etc/nginx/conf.d/default.conf

# 3. 验证配置语法
docker exec colorful-tibet-frontend nginx -t

# 4. 重新加载 Nginx
docker exec colorful-tibet-frontend nginx -s reload

# 5. 验证配置已更新
docker exec colorful-tibet-frontend cat /etc/nginx/conf.d/default.conf | grep -A 5 "location.*api"

# 应该看到：location ^~ /api {
```

### 步骤 3：等待后端启动后测试

```bash
# 等待后端完全启动（检查健康状态）
while ! docker compose ps backend | grep -q "healthy"; do
    echo "等待后端服务启动..."
    sleep 5
done

echo "后端服务已就绪！"

# 测试后端直接访问
docker exec colorful-tibet-frontend wget -O- http://backend:8080/api/spots 2>&1 | head -10

# 测试 Nginx 代理
curl http://localhost/api/spots | head -20
```

## 一键修复脚本

```bash
cd /opt/colorful-tibet

# 1. 等待后端启动
echo "等待后端服务启动..."
while ! docker compose ps backend | grep -q "healthy"; do
    sleep 5
done
echo "后端服务已就绪！"

# 2. 更新 Nginx 配置
docker cp frontend/nginx.conf colorful-tibet-frontend:/etc/nginx/conf.d/default.conf
docker exec colorful-tibet-frontend nginx -t
docker exec colorful-tibet-frontend nginx -s reload

# 3. 验证配置
echo ""
echo "=== 验证配置 ==="
docker exec colorful-tibet-frontend cat /etc/nginx/conf.d/default.conf | grep -A 5 "location.*api"

# 4. 测试
echo ""
echo "=== 测试后端 ==="
docker exec colorful-tibet-frontend wget -O- http://backend:8080/api/spots 2>&1 | head -5

echo ""
echo "=== 测试 Nginx 代理 ==="
curl -s http://localhost/api/spots | head -10
```

## 验证清单

修复后，请确认：

- [ ] `docker compose ps backend` 显示 `(healthy)`
- [ ] `docker exec colorful-tibet-frontend cat /etc/nginx/conf.d/default.conf | grep "location.*api"` 显示 `location ^~ /api {`
- [ ] `docker exec colorful-tibet-frontend wget -O- http://backend:8080/api/spots` 返回 JSON 数据
- [ ] `curl http://localhost/api/spots` 返回 JSON 数据（不是 404 HTML）
- [ ] 浏览器访问 `http://1.15.29.168` 可以正常加载数据

## 如果问题仍然存在

请运行完整诊断：

```bash
cd /opt/colorful-tibet

echo "=== 1. 后端状态 ==="
docker compose ps backend

echo ""
echo "=== 2. 容器内配置 ==="
docker exec colorful-tibet-frontend cat /etc/nginx/conf.d/default.conf | grep -A 10 "location"

echo ""
echo "=== 3. 主机配置 ==="
cat frontend/nginx.conf | grep -A 10 "location"

echo ""
echo "=== 4. 后端测试 ==="
docker exec colorful-tibet-frontend wget -O- http://backend:8080/api/spots 2>&1 | head -10

echo ""
echo "=== 5. Nginx 代理测试 ==="
curl -v http://localhost/api/spots 2>&1 | head -30
```

