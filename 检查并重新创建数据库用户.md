# 检查并重新创建数据库用户

## 🔍 问题

`ERROR 1045 (28000): Access denied for user 'tibet_user'@'localhost'`

这说明 `tibet_user` 用户可能没有创建成功，或者密码不对。

## ✅ 解决步骤

### 步骤1：检查用户是否存在

首先，我们需要进入 MySQL 检查用户是否存在：

```bash
# 停止MySQL
sudo systemctl stop mysql

# 创建socket目录（如果还没有）
sudo mkdir -p /var/run/mysqld
sudo chown mysql:mysql /var/run/mysqld
sudo chmod 755 /var/run/mysqld

# 启动安全模式
sudo mysqld_safe --skip-grant-tables --skip-networking &
sleep 5

# 进入MySQL
mysql -u root
```

### 步骤2：在 MySQL 中检查用户

在 `mysql>` 提示符下执行：

```sql
USE mysql;
SELECT User, Host FROM user WHERE User='tibet_user';
```

如果返回空，说明用户不存在，需要创建。

### 步骤3：删除旧用户（如果存在但有问题）

```sql
DROP USER IF EXISTS 'tibet_user'@'localhost';
FLUSH PRIVILEGES;
```

### 步骤4：重新创建数据库和用户

在 `mysql>` 提示符下执行（一次性复制粘贴）：

```sql
USE mysql;

-- 创建数据库
CREATE DATABASE IF NOT EXISTS tibet_tourism CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 删除旧用户（如果存在）
DROP USER IF EXISTS 'tibet_user'@'localhost';

-- 创建新用户
CREATE USER 'tibet_user'@'localhost' IDENTIFIED BY 'Tibet2024!Tourism';

-- 授权
GRANT ALL PRIVILEGES ON tibet_tourism.* TO 'tibet_user'@'localhost';
GRANT ALL PRIVILEGES ON *.* TO 'tibet_user'@'localhost' WITH GRANT OPTION;

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证用户
SELECT User, Host FROM user WHERE User='tibet_user';

-- 退出
EXIT;
```

### 步骤5：重启 MySQL

执行 `EXIT;` 后，回到 shell：

```bash
# 停止安全模式
sudo pkill mysqld
sudo pkill mysqld_safe

# 正常启动
sudo systemctl start mysql
sleep 5
```

### 步骤6：测试连接

```bash
mysql -u tibet_user -p tibet_tourism
```

输入密码：`Tibet2024!Tourism`

如果成功进入 MySQL，说明配置正确！

## 🎯 完整流程（一键执行）

```bash
# === 1. 准备环境 ===
sudo systemctl stop mysql
sudo mkdir -p /var/run/mysqld
sudo chown mysql:mysql /var/run/mysqld
sudo chmod 755 /var/run/mysqld

# === 2. 启动安全模式 ===
sudo mysqld_safe --skip-grant-tables --skip-networking &
sleep 5

# === 3. 进入MySQL ===
mysql -u root
```

**在 `mysql>` 提示符下执行：**

```sql
USE mysql;
CREATE DATABASE IF NOT EXISTS tibet_tourism CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
DROP USER IF EXISTS 'tibet_user'@'localhost';
CREATE USER 'tibet_user'@'localhost' IDENTIFIED BY 'Tibet2024!Tourism';
GRANT ALL PRIVILEGES ON tibet_tourism.* TO 'tibet_user'@'localhost';
GRANT ALL PRIVILEGES ON *.* TO 'tibet_user'@'localhost' WITH GRANT OPTION;
FLUSH PRIVILEGES;
SELECT User, Host FROM user WHERE User='tibet_user';
EXIT;
```

**回到 shell 后执行：**

```bash
# === 4. 重启MySQL ===
sudo pkill mysqld
sudo pkill mysqld_safe
sudo systemctl start mysql
sleep 5

# === 5. 测试连接 ===
mysql -u tibet_user -p tibet_tourism
# 输入密码：Tibet2024!Tourism
```

## 🔍 验证步骤

如果连接成功，您会看到：

```
Welcome to the MySQL monitor...
mysql>
```

然后可以执行：

```sql
SHOW DATABASES;
USE tibet_tourism;
SHOW TABLES;
EXIT;
```

## ⚠️ 常见问题

### 问题1：还是连接失败

检查密码是否正确：
- 密码是：`Tibet2024!Tourism`（注意大小写和特殊字符）

### 问题2：用户已存在但密码不对

在安全模式下重新设置密码：

```sql
USE mysql;
ALTER USER 'tibet_user'@'localhost' IDENTIFIED BY 'Tibet2024!Tourism';
FLUSH PRIVILEGES;
EXIT;
```

### 问题3：权限不足

确保执行了 `GRANT ALL PRIVILEGES` 命令。

---

**按照上面的步骤重新创建用户，应该就能成功连接了！**


